<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>TrakEM2 Scripting - ImageJ</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"TrakEM2_Scripting","wgTitle":"TrakEM2 Scripting","wgCurRevisionId":41408,"wgRevisionId":41408,"wgArticleId":675,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Scripting","TrakEM2"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"TrakEM2_Scripting","wgRelevantArticleId":675,"wgRequestId":"d9c89796be0bb4538b692b78","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgPreferredVariant":"en","fancytree_path":"/extensions/TreeAndMenu/fancytree"});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user.cssprefs":"ready","user":"ready","user.options":"loading","user.tokens":"loading","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","skins.erudite":"ready"});mw.loader.implement("user.options@0j3lz3q",function($,jQuery,require,module){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens@1ku9xth",function ( $, jQuery, require, module ) {
mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});/*@nomin*/;

});mw.loader.load(["mediawiki.page.startup"]);});</script>
<link rel="stylesheet" href="../load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%252Cshared%257Cmediawiki.sectionAnchor%257Cskins.erudite&amp;only=styles&amp;skin=erudite.css"/>
<script async="" src="../load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=erudite"></script>
<link rel="stylesheet" href="../extensions/TreeAndMenu/fancytree/fancytree.css"/><link rel="stylesheet" href="../extensions/TreeAndMenu/suckerfish/suckerfish.css"/>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="../load.php%3Fdebug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=erudite.css"/>
<meta name="generator" content="MediaWiki 1.28.0"/>
<meta name="description" content="Examples in Jython."/>
<link rel="shortcut icon" href="../skins/ij2.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="http://imagej.net/opensearch_desc.php" title="ImageJ (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="http://imagej.net/api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="ImageJ Atom feed" href="http://imagej.net/index.php?title=Special:RecentChanges&amp;feed=atom"/>

<script type="text/javascript" src="../extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="../extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushPython.js"></script>
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<link rel="stylesheet" type="text/css" media="screen" href="../extensions/SyntaxHighlighter/syntaxhighlighter/styles/shCoreMinit.css" />

	<meta property="og:type" content="article"/>

	<meta property="og:site_name" content="ImageJ"/>

	<meta property="og:title" content="TrakEM2 Scripting"/>

	<meta property="og:description" content="Examples in Jython."/>

	<meta property="og:url" content="http://imagej.net/TrakEM2_Scripting"/>

<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-TrakEM2_Scripting rootpage-TrakEM2_Scripting skin-erudite action-view">
		<div class="mw-jump">
			<a href="TrakEM2_Scripting.html#bodyContent">Skip to content</a>, 			<a href="TrakEM2_Scripting.html#search">Skip to search</a>
		</div>

		<div id="top-wrap" role="banner">
			<h1><a href="http://imagej.net/Welcome" title="ImageJ" rel="home">ImageJ</a></h1>
			<div id="tagline">From ImageJ</div>

			<a id="menubutton" href="TrakEM2_Scripting.html#menu">Menu</a>
			<div id="nav" role="navigation">
			<ul id='menu'>
<li id="menu-item-n-About"><a href="http://imagej.net/ImageJ">About</a></li>
<li id="menu-item-n-Downloads"><a href="http://imagej.net/Downloads">Downloads</a></li>
<li id="menu-item-n-Learn"><a href="http://imagej.net/Learn">Learn</a></li>
<li id="menu-item-n-Develop"><a href="http://imagej.net/Development">Develop</a></li>
<li id="menu-item-n-News"><a href="http://imagej.net/News">News</a></li>
<li id="menu-item-n-Events"><a href="http://imagej.net/Events">Events</a></li>
<li id="menu-item-n-Help"><a href="http://imagej.net/Help">Help</a></li>
</ul>
			</div>
		</div>

		<div id="mw-js-message"></div>
		
		<div id="main" role="main">
			<div id="nav-meta">
			<span id="ca-nstab-main" class="selected"><a href="http://imagej.net/TrakEM2_Scripting" title="View the content page [c]" accesskey="c">Page</a></span><span class="meta-sep">|</span><span id="ca-talk" class="new"><a href="http://imagej.net/index.php?title=Talk:TrakEM2_Scripting&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page [t]" accesskey="t">Discussion</a></span><span class="meta-sep">|</span><span id="ca-viewsource"><a href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span><span class="meta-sep">|</span><span id="ca-history"><a href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;action=history" title="Past revisions of this page [h]" accesskey="h">History</a></span><span class="meta-sep">|</span>			</div>

			<div id="bodyContent">
				<h1>TrakEM2 Scripting</h1>
				
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p>Examples in <a href="http://imagej.net/Jython_Scripting" title="Jython Scripting">Jython</a>.
</p><p>Open the "Plugins - Scripting - Jython Interpreter" (see <a href="http://imagej.net/Scripting_Help" class="mw-redirect" title="Scripting Help">Scripting Help</a>) and make sure there is a TrakEM2 project open, with a display open. Then type or paste the examples below.
</p><p>Or open a new <a href="http://imagej.net/Script_Editor" class="mw-redirect" title="Script Editor">Script Editor</a> window with "File - New - Script", then paste the example, select the "Language - Python", and push the "Run" button.
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="TrakEM2_Scripting.html#Introduction_to_scripting_TrakEM2"><span class="tocnumber">1</span> <span class="toctext">Introduction to scripting TrakEM2</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="TrakEM2_Scripting.html#Get_the_instance_of_a_selected_image"><span class="tocnumber">1.1</span> <span class="toctext">Get the instance of a selected image</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="TrakEM2_Scripting.html#Obtain_the_ImagePlus_of_a_selected_image"><span class="tocnumber">1.2</span> <span class="toctext">Obtain the ImagePlus of a selected image</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="TrakEM2_Scripting.html#Access_the_Layer_and_Selection_of_a_Display"><span class="tocnumber">1.3</span> <span class="toctext">Access the Layer and Selection of a Display</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="TrakEM2_Scripting.html#Lock_all_selected_objects"><span class="tocnumber">1.4</span> <span class="toctext">Lock all selected objects</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="TrakEM2_Scripting.html#Obtain_a_collection_of_selected_images"><span class="tocnumber">1.5</span> <span class="toctext">Obtain a collection of selected images</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="TrakEM2_Scripting.html#Find_the_file_path_of_images_that_lay_under_a_specific_floating_text_label"><span class="tocnumber">1.6</span> <span class="toctext">Find the file path of images that lay under a specific floating text label</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="TrakEM2_Scripting.html#Setting_and_getting_member_objects_in_jython"><span class="tocnumber">1.7</span> <span class="toctext">Setting and getting member objects in jython</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="TrakEM2_Scripting.html#The_properties_of_a_Displayable:_title.2C_color.2C_visibility.2C_locked.2C_alpha.2C_affine_transform.2C_dimensions_and_bounds"><span class="tocnumber">1.8</span> <span class="toctext">The properties of a Displayable: title, color, visibility, locked, alpha, affine transform, dimensions and bounds</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="TrakEM2_Scripting.html#Import_images.2C_montage_them.2C_blend_them_and_save_as_.xml"><span class="tocnumber">1.9</span> <span class="toctext">Import images, montage them, blend them and save as .xml</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-11"><a href="TrakEM2_Scripting.html#Manipulating_Displayable_objects"><span class="tocnumber">2</span> <span class="toctext">Manipulating Displayable objects</span></a>
<ul>
<li class="toclevel-2 tocsection-12"><a href="TrakEM2_Scripting.html#Resetting_the_affine_transform_of_all_images_in_a_Layer"><span class="tocnumber">2.1</span> <span class="toctext">Resetting the affine transform of all images in a Layer</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="TrakEM2_Scripting.html#Adding_areas_to_an_AreaList_by_scanning_pixel_values_in_the_slices_of_a_stack"><span class="tocnumber">2.2</span> <span class="toctext">Adding areas to an AreaList by scanning pixel values in the slices of a stack</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="TrakEM2_Scripting.html#Extract_areas_from_an_arealist_and_put_them_as_ROIs_in_ImageJ.27s_ROI_Manager"><span class="tocnumber">2.3</span> <span class="toctext">Extract areas from an arealist and put them as ROIs in ImageJ's ROI Manager</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15"><a href="TrakEM2_Scripting.html#Adding_images"><span class="tocnumber">3</span> <span class="toctext">Adding images</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="TrakEM2_Scripting.html#Adding_a_single_image_to_a_layer_shown_in_an_open_display"><span class="tocnumber">3.1</span> <span class="toctext">Adding a single image to a layer shown in an open display</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="TrakEM2_Scripting.html#Copying_images_between_two_open_projects"><span class="tocnumber">3.2</span> <span class="toctext">Copying images between two open projects</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="TrakEM2_Scripting.html#Concatenating_multiple_project_XML_files_by_copying_all_their_layers"><span class="tocnumber">3.3</span> <span class="toctext">Concatenating multiple project XML files by copying all their layers</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-19"><a href="TrakEM2_Scripting.html#Measure"><span class="tocnumber">4</span> <span class="toctext">Measure</span></a>
<ul>
<li class="toclevel-2 tocsection-20"><a href="TrakEM2_Scripting.html#Measure_the_minimal_distance_from_each_ball_to_a_surface_defined_by_a_profile_list"><span class="tocnumber">4.1</span> <span class="toctext">Measure the minimal distance from each ball to a surface defined by a profile list</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-21"><a href="TrakEM2_Scripting.html#Interacting_with_Layers_.28Sections.29"><span class="tocnumber">5</span> <span class="toctext">Interacting with Layers (Sections)</span></a>
<ul>
<li class="toclevel-2 tocsection-22"><a href="TrakEM2_Scripting.html#Calibrating_and_setting_the_Z_dimension"><span class="tocnumber">5.1</span> <span class="toctext">Calibrating and setting the Z dimension</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-23"><a href="TrakEM2_Scripting.html#Interacting_with_Treeline.2C_AreaTree_and_Connector"><span class="tocnumber">6</span> <span class="toctext">Interacting with Treeline, AreaTree and Connector</span></a>
<ul>
<li class="toclevel-2 tocsection-24"><a href="TrakEM2_Scripting.html#Obtaining_the_X.2CY.2CZ_coordinates_of_all_nodes_in_a_Tree"><span class="tocnumber">6.1</span> <span class="toctext">Obtaining the X,Y,Z coordinates of all nodes in a Tree</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="TrakEM2_Scripting.html#Sorting_nodes_by_their_tags"><span class="tocnumber">6.2</span> <span class="toctext">Sorting nodes by their tags</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="TrakEM2_Scripting.html#Compute_the_betweenness_centrality_of_every_node"><span class="tocnumber">6.3</span> <span class="toctext">Compute the betweenness centrality of every node</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="TrakEM2_Scripting.html#Compute_the_degree_of_every_node"><span class="tocnumber">6.4</span> <span class="toctext">Compute the degree of every node</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="TrakEM2_Scripting.html#Find_branch_nodes_or_end_nodes"><span class="tocnumber">6.5</span> <span class="toctext">Find branch nodes or end nodes</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="TrakEM2_Scripting.html#Find_out_at_which_nodes_the_tree_is_connected_to_other_trees.2C_via_Connector"><span class="tocnumber">6.6</span> <span class="toctext">Find out at which nodes the tree is connected to other trees, via Connector</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="TrakEM2_Scripting.html#How_to_find_out_the_network_of_all_arbors.2C_related_via_Connector_instances"><span class="tocnumber">6.7</span> <span class="toctext">How to find out the network of all arbors, related via Connector instances</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="TrakEM2_Scripting.html#Measure_all_spine_necks_in_a_neuronal_arbor"><span class="tocnumber">6.8</span> <span class="toctext">Measure all spine necks in a neuronal arbor</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-32"><a href="TrakEM2_Scripting.html#Interact_with_a_Ball_object"><span class="tocnumber">7</span> <span class="toctext">Interact with a Ball object</span></a>
<ul>
<li class="toclevel-2 tocsection-33"><a href="TrakEM2_Scripting.html#Set_the_radius_of_all_balls_of_all_Ball_objects_in_a_project"><span class="tocnumber">7.1</span> <span class="toctext">Set the radius of all balls of all Ball objects in a project</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="TrakEM2_Scripting.html#Export_all_Ball_objects_as_a_CSV_file"><span class="tocnumber">7.2</span> <span class="toctext">Export all Ball objects as a CSV file</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-35"><a href="TrakEM2_Scripting.html#Generate_3D_meshes"><span class="tocnumber">8</span> <span class="toctext">Generate 3D meshes</span></a>
<ul>
<li class="toclevel-2 tocsection-36"><a href="TrakEM2_Scripting.html#Generate_a_3D_mesh_for_an_AreaList"><span class="tocnumber">8.1</span> <span class="toctext">Generate a 3D mesh for an AreaList</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="TrakEM2_Scripting.html#Generate_a_3D_mesh_for_an_AreaTree"><span class="tocnumber">8.2</span> <span class="toctext">Generate a 3D mesh for an AreaTree</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-38"><a href="TrakEM2_Scripting.html#Save_the_project_while_running_a_task"><span class="tocnumber">9</span> <span class="toctext">Save the project while running a task</span></a></li>
<li class="toclevel-1 tocsection-39"><a href="TrakEM2_Scripting.html#Create_a_TrakEM2_project_for_fast_visualization.2C_without_mipmaps"><span class="tocnumber">10</span> <span class="toctext">Create a TrakEM2 project for fast visualization, without mipmaps</span></a></li>
<li class="toclevel-1 tocsection-40"><a href="TrakEM2_Scripting.html#Create_a_snapshot_in_8-bit.2C_16-bit.2C_32-bit_or_RGB"><span class="tocnumber">11</span> <span class="toctext">Create a snapshot in 8-bit, 16-bit, 32-bit or RGB</span></a></li>
<li class="toclevel-1 tocsection-41"><a href="TrakEM2_Scripting.html#Enrich_the_GUI_of_TrakEM"><span class="tocnumber">12</span> <span class="toctext">Enrich the GUI of TrakEM</span></a>
<ul>
<li class="toclevel-2 tocsection-42"><a href="TrakEM2_Scripting.html#Add_an_extra_tab_to_a_Display"><span class="tocnumber">12.1</span> <span class="toctext">Add an extra tab to a Display</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-43"><a href="TrakEM2_Scripting.html#See_also"><span class="tocnumber">13</span> <span class="toctext">See also</span></a>
<ul>
<li class="toclevel-2 tocsection-44"><a href="TrakEM2_Scripting.html#TrakEM2_tutorials"><span class="tocnumber">13.1</span> <span class="toctext">TrakEM2 tutorials</span></a></li>
<li class="toclevel-2 tocsection-45"><a href="TrakEM2_Scripting.html#Jython_scripting"><span class="tocnumber">13.2</span> <span class="toctext">Jython scripting</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="TrakEM2_Scripting.html#Jython_scripts_for_TrakEM2"><span class="tocnumber">13.3</span> <span class="toctext">Jython scripts for TrakEM2</span></a></li>
</ul>
</li>
</ul>
</div>

<h1><span class="mw-headline" id="Introduction_to_scripting_TrakEM2">Introduction to scripting TrakEM2</span></h1>
<p>Some basics:
</p>
<ul><li>The canvas into which images are dragged and visualized is part of a <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Display.html">Display</a> object. The latter has methods to access its <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Selection.html">Selection</a>, as well as the <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Layer.html">Layer</a> and <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/LayerSet.html">LayerSet</a> that the Display is viewing.</li>
<li>The Layer contains 2D objects like <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Patch.html">Patch</a> (each Patch wraps an image) and <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/DLabel.html">DLabel</a> (floating text).</li>
<li>The LayerSet contains 3D objects like <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/AreaList.html">AreaList</a>, <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Pipe.html">Pipe</a>, <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Polyline.html">Polyline</a>, <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Ball.html">Ball</a>, <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Dissector.html">Dissector</a>, <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Treeline.html">Treeline</a> and <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Stack.html">Stack</a> (the latter wraps an ij.ImagePlus that contains an ij.ImageStack).</li></ul>
<p>Both Layer and LayerSet are in a way containers. The LayerSet contains as well a list of Layer. The Display merely views the data in a LayerSet, one Layer at a time.
</p><p>See a <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/img/trakem2_datastructure_diagram.svg">TrakEM2 class diagram</a> for a complete list.
</p><p>See also the complete <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api">TrakEM2 API documentation</a>
</p><p>To run a script, follow instructions as indicated in the <a href="http://imagej.net/Scripting_Help" class="mw-redirect" title="Scripting Help">Scripting Help</a>.
</p>
<h3><span class="mw-headline" id="Get_the_instance_of_a_selected_image">Get the instance of a selected image</span></h3>
<pre class="brush:python">
&gt;&gt;&gt; p = Display.getFront().getActive()
&gt;&gt;&gt; print p
090504_0314_ex0768.mrc z=0.0 #67398
</pre>
<p><br />
</p>
<h3><span class="mw-headline" id="Obtain_the_ImagePlus_of_a_selected_image">Obtain the ImagePlus of a selected image</span></h3>
<pre class="brush:python">
&gt;&gt;&gt; p = Display.getFront().getActive()
&gt;&gt;&gt; imp = p.getImagePlus()
&gt;&gt;&gt; print imp.width, imp.height
2048 2048
</pre>
<p><br />
</p>
<h3><span class="mw-headline" id="Access_the_Layer_and_Selection_of_a_Display">Access the Layer and Selection of a Display</span></h3>
<p>The 'front' is the last activated display window. If there's only one display window, then that is 'front'.
To access the front display, we call static function <i>getFront()</i> in namespace <i><a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Display.html">Display</a></i>:
</p>
<pre class="brush:python">
&gt;&gt;&gt; front = Display.getFront()
&gt;&gt;&gt; layer = front.getLayer()
&gt;&gt;&gt; layer_set = front.getLayerSet()
&gt;&gt;&gt; sel = front.getSelection()
&gt;&gt;&gt; print sel.getSelected().size()
10
&gt;&gt;&gt; print sel.isEmpty()
0
</pre>
<p>In Jython, 1 is True and 0 is False
</p><p>The most interesting data members of a <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Display.html">Display</a>, as seen above, are mainly the  <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Layer.html">Layer</a> and the <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Selection.html">Selection</a>.
</p>
<h3><span class="mw-headline" id="Lock_all_selected_objects">Lock all selected objects</span></h3>
<pre class="brush:python">
for d in Display.getFront().getSelected():
  d.setLocked(True)
</pre>
<h3><span class="mw-headline" id="Obtain_a_collection_of_selected_images">Obtain a collection of selected images</span></h3>
<p>The <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Selection.html">Selection</a> object of a <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Display.html">Display</a> can return a number of collections with any selected objects in it, for example of type <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Patch.html">Patch</a> (those that wrap an image). All you need to do is to call <i><a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Selection.html#getSelected(java.lang.Class)">getSelected</a></i> with the name of the class to filter for:
</p>
<pre class="brush:python">
for d in Display.getSelected(Patch):
  print d.title
</pre>
<p>The above is a static call that retrieves the list for whichever Display window happens to be activated, in front of all others. If you have a Display instance, perform the same operation via the Display's Selection:
</p>
<pre class="brush:python">
front = Display.getFront()
selection = front.getSelection()
for d in selection.get(Patch):
  print d.title
</pre>
<h3><span class="mw-headline" id="Find_the_file_path_of_images_that_lay_under_a_specific_floating_text_label">Find the file path of images that lay under a specific floating text label</span></h3>
<p>The idea is to add floating text labels over images (using the Text Tool), and then to search for all the images that are under the X,Y coordinate of each label. Then we print the 
</p>
<pre class="brush:python">
regularExpression = ".*fold.*"

for layer in Display.getFront().getLayerSet().getLayers():
  for label in layer.getDisplayables(DLabel):
    if label.getTitle().matches(regularExpression):
      tx = label.getAffineTransform().getTranslationX()
      ty = label.getAffineTransform().getTranslationY()
      patches = layer.find(Patch, tx, ty)
      for patch in patches:
        print patch.getImageFilePath()
</pre>
<h3><span class="mw-headline" id="Setting_and_getting_member_objects_in_jython">Setting and getting member objects in jython</span></h3>
<p>In Jython as in Python, member objects have automatically <i>get</i> and <i>set</i> functions.
</p><p>For example, altough a <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Displayable.html">Displayable</a> has a private <i>String title</i> member, this is valid python code for getting and setting the title of a Displayable like a Patch:
</p>
<pre class="brush:python">
&gt;&gt;&gt; p = Display.getFront().getActive()
&gt;&gt;&gt; print p.title
090504_0314_ex0768.mrc
</pre>
<p>Above, a Patch takes as title the name of the file containing the ImagePlus, by default. Let's change the title to something else:
</p>
<pre class="brush:python">
&gt;&gt;&gt; p = Display.getFront().getActive()
&gt;&gt;&gt; p.title = "A new name for this Patch"
&gt;&gt;&gt; print p.title
A new name for this Patch
</pre>
<h3><span class="mw-headline" id="The_properties_of_a_Displayable:_title.2C_color.2C_visibility.2C_locked.2C_alpha.2C_affine_transform.2C_dimensions_and_bounds">The properties of a Displayable: title, color, visibility, locked, alpha, affine transform, dimensions and bounds</span></h3>
<p>Let's set a few values:
</p>
<pre class="brush:python">
&gt;&gt;&gt; p = Display.getFront().getActive()
&gt;&gt;&gt; p.title = "Test image"
&gt;&gt;&gt; p.alpha = 0.4
&gt;&gt;&gt; p.visible = True
&gt;&gt;&gt; p.locked = False
&gt;&gt;&gt; from java.awt import Color
&gt;&gt;&gt; p.color = Color.blue
</pre>
<p>Tell all displays to update the canvas, so we see the changes:
</p>
<pre class="brush:python">
&gt;&gt;&gt; Display.repaint()
</pre>
<p><br />
Let's read a few values:
</p>
<pre class="brush:python">
&gt;&gt;&gt; p.getAffineTransform()
AffineTransform[[1.0, 0.0, 474.0], [0.0, 1.0, 567.0]]
&gt;&gt;&gt; print p.getBoundingBox()
java.awt.Rectangle[x=474,y=567,width=2048,height=2048]
</pre>
<p>The affine transform cannot be set, because it's a final member. But itself the value may be edited via <i>setAffineTransform</i>:
</p>
<pre class="brush:python">
&gt;&gt;&gt; from java.awt.geom import AffineTransform
&gt;&gt;&gt; aff = AffineTransform()
&gt;&gt;&gt; aff.scale(2.0, 2.0)
&gt;&gt;&gt; p.setAffineTransform(aff)
&gt;&gt;&gt; p.updateBucket()
</pre>
<p>Be careful: java's AffineTranform does concatenations and not pre-concatenations (order matters in matrix multiplication).
</p><p>In most occasions, what you want can be accomplished with <i><a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Displayable.html#preTransform(java.awt.geom.AffineTransform,%20boolean)">preTransform</a></i>, such as translating an image:
</p>
<pre class="brush:python">
&gt;&gt;&gt; from java.awt.geom import AffineTransform
&gt;&gt;&gt; aff = AffineTransform()
&gt;&gt;&gt; aff.translate(300, -400)
&gt;&gt;&gt; p.preTransform(aff, True)
</pre>
<p>More convenient are the methods <i>scale</i>, <i>translate</i>, <i>rotate</i> and particularly <i>preTransform</i>, for the manipulation of a <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/api/ini/trakem2/display/Displayable.html">Displayable</a>'s affine transform (see <a rel="nofollow" class="external text" href="http://java.sun.com/javase/6/docs/api/java/awt/geom/AffineTransform.html">AffineTransform</a>) and that of its linked Displayables (any transform propagates to the linked ones).
</p><p>If you change the affine transform of a Displayable directly (by calling <i>getAffineTransform()</i> and then manipulating it), keep in mind that you will most likely screw up the internal cached maps for fast location of the Displayable object. To solve that, be sure to call <i>updateBucket()</i> on the affected Displayable object.
</p><p><br />
</p>
<h3><span class="mw-headline" id="Import_images.2C_montage_them.2C_blend_them_and_save_as_.xml">Import images, montage them, blend them and save as .xml</span></h3>
<p>What follows is a small script that imports images from a single folder, sorting out which images go to what layer (section) by matching a regular expression pattern on the file name.
</p><p>Then the images are montaged layer-wise, and blended together (the borders of the overlapping images are faded out).
</p><p>Notice that, for this script to work for you, you will have to edit two lines:
</p>
<pre> 1. The source <i><b>folder</b></i> where images are to be found.
 2. The <i><b>pattern</b></i> to match, which dictates which image goes to which layer.
</pre>
<p>Be sure as well to create as many layers as you need. If you don't know, use the  <i>getLayer</i> method on the <i>layerset</i> variable, which has the ability to create a new layer when asked to get one for a Z for which a layer doesn't exist yet.
</p><p>Documentation you may want to look at:
<a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/Project.html#newFSProject(java.lang.String,%20ini.trakem2.tree.TemplateThing,%20java.lang.String)">Project.newFSProject</a>, <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Patch.html#createPatch(ini.trakem2.Project,%20java.lang.String)">Patch.createPatch</a>, <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Layer.html#add(ini.trakem2.display.Displayable)">Layer.add</a>, <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/mpicbg/trakem2/align/Align.html">Align</a>, <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/mpicbg/trakem2/align/AlignTask.html">AlignTask</a>,
</p><p><br />
</p>
<pre class="brush:python">
# Albert Cardona 2011-06-05
# Script for Colenso Speer

import os, re

#folder = "/path/to/folder/with/all/images/"
folder = "/home/albert/Desktop/t2/example-data/images/2043_5_6_7"

# 1. Create a TrakEM2 project
project = Project.newFSProject("blank", None, folder)
# OR: get the first open project
# project = Project.getProjects().get(0)

layerset = project.getRootLayerSet()

#  2. Create 10 layers (or as many as you need)
for i in range(10):
  layerset.getLayer(i, 1, True)

# ... and update the LayerTree:
project.getLayerTree().updateList(layerset)
# ... and the display slider
Display.updateLayerScroller(layerset)

# 3. To each layer, add images that have "_zN_" in the name
#     where N is the index of the layer
#     and also end with ".tif"
filenames = os.listdir(folder)
for i,layer in enumerate(layerset.getLayers()):
  # EDIT the following pattern to match the filename of the images
  # that must be inserted into section at index i:
  pattern = re.compile(".*_z" + str(i) + "_.*\.tif")
  for filename in filter(pattern.match, filenames):
    filepath = os.path.join(folder, filename)
    patch = Patch.createPatch(project, filepath)
    layer.add(patch)
  # Update internal quadtree of the layer
  layer.recreateBuckets()

# 4. Montage each layer independently
from mpicbg.trakem2.align import Align, AlignTask
param = Align.ParamOptimize()  # which extends Align.Param
param.sift.maxOctaveSize = 512
#  ... above, adjust other parameters as necessary
# See:
#    features: https://fiji.sc/javadoc/mpicbg/trakem2/align/Align.Param.html
#    transformation models: https://fiji.sc/javadoc/mpicbg/trakem2/align/Align.ParamOptimize.html
#    sift: https://fiji.sc/javadoc/mpicbg/imagefeatures/FloatArray2DSIFT.Param.html
AlignTask.montageLayers(param, layerset.getLayers(), False, False, False, False)

# 5. Resize width and height of the world to fit the montages
layerset.setMinimumDimensions()

# 6. Blend images of each layer
Blending.blendLayerWise(layerset.getLayers(), True, None)

# 7. Save the project
project.saveAs(os.path.join(folder, "montages.xml"), False)

print "Done!"
</pre>
<h1><span class="mw-headline" id="Manipulating_Displayable_objects">Manipulating Displayable objects</span></h1>
<h3><span class="mw-headline" id="Resetting_the_affine_transform_of_all_images_in_a_Layer">Resetting the affine transform of all images in a Layer</span></h3>
<p>Suppose you open the project and find that the images of a Layer have non-rigid affine transforms, and you'd like to remove the non-rigid part. A reasonable approach is to reset their affine transforms to identity, and then translate them to approximately where they used to be (based on their bounding box):
</p>
<pre class="brush:python">
layer = Display.getFront().getLayer()

# Get all selected images
# patches = Display.getFront().getSelection().getSelected(Patch)

# Get all images in the current layer
patches = layer.getDisplayables(Patch)

for patch in patches:
  bounds = patch.getBoundingBox()
  patch.getAffineTransform().setToIdentity()
  patch.translate(bounds.x, bounds.y, False)

Display.repaint()
</pre>
<p>Save the above into a file named "reset_affine_transforms.py" under plugins directory or subdirectory to run it directly from the menus, or copy-paste it into the Jython Interpreter.
</p><p>See also: the different methods for manipulating the affine transform of a <a rel="nofollow" class="external text" href="http://t2.ini.uzh.ch/api/ini/trakem2/display/displayable.html">Displayable object</a> like a Patch.
</p><p>And a WARNING: if you modify the AffineTransform of a Patch and don't call then any of the Displayable methods for doing so as well (like we did above: the script calls "Displayable.translate"), then you must update the bucket yourself:
</p>
<pre class="brush:python">
patch.updateBucket()
</pre>
<p>The bucket is the region of the 2D world where the Patch lives. Picture the world as a checkerboard, where a given image, wrapped in a Patch object, belongs to each of the square that it intersects. Failing to update the bucket will result in improper canvas repaints--the Patch cannot be found.
</p><p><br />
</p>
<h3><span class="mw-headline" id="Adding_areas_to_an_AreaList_by_scanning_pixel_values_in_the_slices_of_a_stack">Adding areas to an AreaList by scanning pixel values in the slices of a stack</span></h3>
<p>The script below is the same as the command "Import - Import labels as arealists".
</p>
<pre class="brush:python">
from ini.trakem2 import Project
from ini.trakem2.utils import AreaUtils
from ini.trakem2.display import AreaList
from java.awt import Color

# Obtain an image stack
#imp = IJ.getImage()
imp = WindowManager.getImage("0_5_filtered.tif")

# Obtain the opened TrakEM2 project
p = Project.getProjects()[0]

# Obtain the LayerSet
layerset = p.getRootLayerSet()

# Create a new AreaList, named "synapses"
ali = AreaList(p, "synapses", 0, 0)

# Add the AreaList to the datastructures:
layerset.add(ali)
p.getProjectTree().insertSegmentations([ali])

# Obtain the image stack
stack = imp.getImageStack()

# Iterate every slice of the stack
for i in range(1, imp.getNSlices() +1):
  ip = stack.getProcessor(i) # 1-based
  # Extract all areas (except background) into a map of value vs. java.awt.geom.Area
  m = AreaUtils.extractAreas(ip)
  # Report progress
  print i, ":", len(m)
  # Get the Layer instance at the corresponding index
  layer = layerset.getLayers().get(i-1) # 0-based
  # Add the first Area instance to the AreaList at the proper Layer
  ali.addArea(layer.getId(), m.values().iterator().next())

# Change the color of the AreaList
ali.setColor(Color.magenta)

# Ensure bounds are as constrained as possible
ali.calculateBoundingBox(None)

Display.repaint()

</pre>
<p><br />
</p>
<h3><span class="mw-headline" id="Extract_areas_from_an_arealist_and_put_them_as_ROIs_in_ImageJ.27s_ROI_Manager">Extract areas from an arealist and put them as ROIs in ImageJ's ROI Manager</span></h3>
<pre class="brush:python">
# Albert Cardona 2012-06-19
# Obtain an arealist and add all its areas as ROIs in the ROI Manager

from ini.trakem2.display import Display, AreaList
from ij.gui import ShapeRoi
from ij.plugin.frame import RoiManager

def getRoiManager():
  """ Obtain a valid instance of the ROI Manager.
  Notice that it could still be null if its window is closed."""
  if RoiManager.getInstance() is None:
    RoiManager()
  return RoiManager.getInstance()

def putAreas(arealist):
  """ Take all areas of an AreaList and put them in the ROI Manager."""
  for layer in arealist.getLayerRange():
    area = arealist.getAreaAt(layer)
    if area is not None and not area.isEmpty():
      roi = ShapeRoi(area)
      getRoiManager().addRoi(roi)

def run():
  front = Display.getFront()
  layers = front.getLayerSet().getLayers()
  arealists = front.getSelection().getSelected(AreaList)
  if arealists.isEmpty():
    IJ.log("No arealists selected!")
    return
  # Extract areas as ROIs for the first one:
  putAreas(arealists[0])

run()
</pre>
<p><br />
Notice that python (and jython) lets you use object instance methods as first-class functions, and constructors as well. This enables us to rewrite the "putAreas" function in a functional way, without using any temporary variables and without any if/else logic:
</p>
<pre class="brush:python">
def putAreas(arealist):
  """ Take all areas of an AreaList and put them in the ROI Manager."""
  def put(arealist):
  map(getRoiManager().addRoi,
      map(ShapeRoi,
          filter(lambda area: not area.isEmpty(),
                 filter(None,
                        map(arealist.getAreaAt, arealist.getLayerRange())))))
</pre>
<h1><span class="mw-headline" id="Adding_images">Adding images</span></h1>
<h3><span class="mw-headline" id="Adding_a_single_image_to_a_layer_shown_in_an_open_display">Adding a single image to a layer shown in an open display</span></h3>
<pre class="brush:python">
# Obtain a pointer to the frontmost open display:
front = Display.getFront()
# Open an image
filepath = "/path/to/image.tif"
imp = IJ.openImage(filepath)
# Create a new Patch, which wraps an image
patch = Patch(front.project, imp.title, 0, 0, imp)
patch.project.loader.addedPatchFrom(filepath, patch)
# Add it to a layer
front.layer.add(patch)
</pre>
<p><br />
</p>
<h3><span class="mw-headline" id="Copying_images_between_two_open_projects">Copying images between two open projects</span></h3>
<p>The script checks that at least two displays are open, and that they belong to two different projects. Then offers a dialog to choose the direction of copying, and finally copies all images, or all visible or selected images, from one project to the other:
</p>
<pre class="brush:python">
# Albert Cardona 20100201
# Script to copy all images, all visible images, or all selected images
# from a source layer to a target layer.
# To run the script, put it under Fiji plugins folder or subfolder and call "Plugins - Scripting - Update Fiji"
# and make sure you have at least two projects open, each with at least one display open.
# 
# Written for Natalya at Graham Knott's group, EPFL

from ini.trakem2.display import *
from ij.gui import GenericDialog
from ij import IJ
from array import array


def run():
	# Check precondition: at least some displays open
	displays = Display.getDisplays()
	if displays.isEmpty():
		IJ.showMessage("Could not find any TrakEM2 displays open!")
		return
	# Check precondition: at least two displays from two different projects 
	projects = {}
	for display in displays:
		projects[display.project] = display
	if len(projects) &lt; 2:
		IJ.showMessage("You need at least two projects with at least one display open for each!")
		return
	# Show choices
	gd = GenericDialog("Copying images between projects")
	titles = array(String, [display.getFrame().getTitle() for display in displays])
	gd.addChoice("Source layer:", titles, titles[0])
	gd.addChoice("Target layer:", titles, titles[1])
	choices = ["All images", "All visible images", "All selected images"]
	gd.addChoice("Copy:", choices, choices[0])
	gd.showDialog()
	if gd.wasCanceled():
		return
	source = displays[gd.getNextChoiceIndex()]
	target = displays[gd.getNextChoiceIndex()]
	if source == target:
		IJ.showMessage("You must choose different source and target layers!")
		return
	copy_mode = gd.getNextChoiceIndex()
	patches = None
	if 0 == copy_mode:
		patches = source.getLayer().getDisplayables(Patch)
	elif 1 == copy_mode:
		patches = source.getLayer().getDisplayables(Patch, True)
	else:
		patches = source.getSelection().getSelected(Patch)
	if 0 == len(patches):
		IJ.showMessage("No images to copy with option: " + choices[copy_mode])
		return
	# Copy images
	for patch in patches:
		p = patch.clone(target.project, False)
		target.getLayer().add(p)
	target.getLayerSet().enlargeToFit(patches)
	IJ.showStatus("Done copying images between layers.")

run()
</pre>
<p>To create a script with the above code, copy paste it into a file with an underscore in its name and extension ".py". Then place it in Fiji's plugins folder or subfolder thereof. Finally, restart Fiji or just call "Plugins - Scripting - Refresh Jython Scripts".
</p><p><br />
</p>
<h3><span class="mw-headline" id="Concatenating_multiple_project_XML_files_by_copying_all_their_layers">Concatenating multiple project XML files by copying all their layers</span></h3>
<pre class="brush:python">
# Albert Cardona 2010-06-30 for JC Rah
# Takes a list of project XML files
# and grabs all layers in order
# and clones each and all its images
# and then adds it to a newly created project named "all_layers.xml"


from ini.trakem2 import Project
from ini.trakem2.display import Patch
from ini.trakem2.utils import Utils
from ij import IJ


source_dir = "/path/to/projects/" # MUST have ending slash
project_paths = ["project1.xml", "project2.xml", "project3.xml"]

# folder to save the target project at
target_folder = source_dir

def merge_layers():
  # Create a new project target_folder as the storage folder:
  target = Project.newFSProject("blank", None, target_folder)
  # Save it there as "all_layers.xml" so we can call "save()" on it later
  target.saveAs(target_folder + "all_layers.xml", True)
  targetlayerset = target.getRootLayerSet()
  z = 0
  # For each project to concatenate, open it, and:
  for path in project_paths:
    IJ.log("Processing project " + path)
    project = Project.openFSProject(source_dir + path, False)
    rectangle = project.getRootLayerSet().get2DBounds()
    # For each layer in the project, create a new layer "targetlayer" to host a copy of its images:
    for layer in project.getRootLayerSet().getLayers():
      targetlayer = targetlayerset.getLayer(z, 1, True)
      z += 1
      # Add to the new layer copies of each image
      for ob in layer.getDisplayables():
        targetlayer.add(ob.clone(target, False)) # clone in the context of the target project
    project.getLoader().setChanged(False) # avoid dialog at closing
    project.destroy()
    targetlayerset.setMinimumDimensions()
  # Regenerate all image mipmaps
  futures = []
  for patch in targetlayerset.getDisplayables(Patch):
    futures.append(patch.updateMipMaps())
  Utils.wait(futures)
  target.save() # to validate mipmaps
  #target.destroy()  # comment out to close it
  IJ.log("Done!")

# Invoke the function!
merge_layers()
</pre>
<h1><span class="mw-headline" id="Measure">Measure</span></h1>
<h3><span class="mw-headline" id="Measure_the_minimal_distance_from_each_ball_to_a_surface_defined_by_a_profile_list">Measure the minimal distance from each ball to a surface defined by a profile list</span></h3>
<p>Suppose for example that, using a <a rel="nofollow" class="external text" href="http://t2.ini.uzh.ch/trakem2_manual.html#balls">Ball object</a>, you have clicked on each vesicle of a synaptic terminal. And that, using a <a rel="nofollow" class="external text" href="http://t2.ini.uzh.ch/trakem2_manual.html#profiles">profile list</a>, you have traced the surface area of a synapse.
</p>
<table>
<tr>
<td style="vertical-align:top"><div class="thumb tleft"><div class="thumbinner" style="width:302px;"><a href="http://imagej.net/File:Synaptic-surface-and-vesicles.jpg" class="image"><img alt="" src="../_images/5/5d/Synaptic-surface-and-vesicles.jpg" width="300" height="381" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="http://imagej.net/File:Synaptic-surface-and-vesicles.jpg" class="internal" title="Enlarge"></a></div>3D view of a synaptic surface and its vesicles</div></div></div>
</td>
<td style="vertical-align:top"><div class="thumb tleft"><div class="thumbinner" style="width:302px;"><a href="http://imagej.net/File:Synaptic-surface-and-vesicles-measurements.png" class="image"><img alt="" src="../_images/e/e9/Synaptic-surface-and-vesicles-measurements.png" width="300" height="371" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="http://imagej.net/File:Synaptic-surface-and-vesicles-measurements.png" class="internal" title="Enlarge"></a></div>Synaptic vesicle measurements of the minimal distance from each vesicle to the synaptic surface</div></div></div>
</td></tr></table>
<p>Using the following script, we generate a surface from the profile list, and then measure, for each synaptic vesicle, its minimal distance to the synaptic surface.
</p><p>The results are finally listed in a results table, from which column-ordered data may be exported for further processing in a spreadsheet.
</p>
<pre class="brush:python">
# Albert Cardona 20100201
# Select a Ball and a Profile, and list the minimal distances of each ball
# to the nearest vertex of the mesh created by the profile list to which
# the profile belongs.
# 
# As asked by Graham Knott and Natalya, from EPFL


from ini.trakem2.display import Display, Ball, Profile
from ini.trakem2.utils import M, Utils
from ij import IJ
from ij.measure import ResultsTable
from ij.gui import GenericDialog
from java.util import HashSet


def run():
	sel = Display.getSelected()
	# Check conditions: one Ball and one Profile only must be selected
	if sel is None or sel.isEmpty():
		IJ.log("Please select a Ball and a Profile!")
		return
	c = [ob.getClass() for ob in sel]
	if Ball in c and Profile in c and 2 == sel.size():
		pass
	else:
		IJ.log("Please select just one Ball and one Profile")
		return
	obs = {}
	for ob in sel:
		obs[ob.getClass()] = ob
	balls = obs[Ball].getWorldBalls()
	profile = obs[Profile]
	profiles = []
	# Gather triangles from profile mesh (into a HashSet to remove the many duplicate vertices)
	verts = HashSet(Profile.generateTriangles(profile.project.findProjectThing(profile).getParent(), 1))
	# Prepare a results table
	rt = ResultsTable()
	rt.setPrecision(2)
	rt.setHeading(0, "Index")
	rt.setHeading(1, "Min distance to surface")
	# Fill data rows
	unit = profile.layer.parent.calibration.unit
	i = 0
	count = len(balls)
	for i in range(count):
		rt.incrementCounter();
		rt.addLabel("units", unit)
		rt.addValue(0, i)
		b = balls[i]
		# For each ball, measure the minimal distance to any of the triangle vertices.
		rt.addValue(1, Math.sqrt(reduce(Math.min, [M.distanceSq(b[0], b[1], b[2], vert.x, vert.y, vert.z) for vert in verts])))
		Utils.showProgress(float(i)/count)
	rt.show("Distances from ball to profile list surface")
	# Reset progress bar
	Utils.showProgress(1)

run()
</pre>
<p>A similar measurement may be obtained like the following, if you don't mind typing in the IDs of the Ball (vesicles) and AreaList (the synaptic surface), and getting the results summarized into mean, standard deviation and median (of the distances of each vesicle to the mesh):
</p>
<pre class="brush:python">
# The IDs of the Ball and AreaList instances
vesiclesID = 1543
synapticSurfaceID = 1541

# Obtain the two TrakEM2 instances
project = Project.getProjects()[0]
vesicles = project.findById(vesiclesID)
synapticSurface = project.findById(synapticSurfaceID)

# A set of unique vertices defining the synaptic surface
vertices = set(synapticSurface.generateTriangles(1, 2))

# For every vesicle, measure its shortest distance to a vertex
distances = [reduce(min, map(lambda v: p.distance(v), vertices))
             for p in vesicles.asWorldPoints()]

# Compute average, median and standard deviation
mean = sum(distances) / len(distances)
stdDev = Math.sqrt(reduce(lambda s, e: s + pow(e - mean, 2),
                          distances, 0)) / len(distances)
median = sorted(distances)[len(distances)/2]

print mean, stdDev, median
</pre>
<h1><span class="mw-headline" id="Interacting_with_Layers_.28Sections.29">Interacting with Layers (Sections)</span></h1>
<h3><span class="mw-headline" id="Calibrating_and_setting_the_Z_dimension">Calibrating and setting the Z dimension</span></h3>
<p>Each <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Layer.html">Layer</a> stores a Z coordinate and a thickness value with <i>double</i> precision. The Z  coordinate is in pixels.
</p><p>How to compute the Z coordinate of a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Layer.html">Layer</a>: suppose that the calibration specifies 4x4x50 nm. This means 4 nm/px in the X axis, 4 nm/px in the Y axis, and 50 nm/px in the Z axis. It is assumed that you set this values by right-clicking on the canvas window and choosing "Display - Calibration...", which opens the familiar ImageJ dialog for image calibration.
</p><p>Then you have to compute the thickness of a section relative to X axis coordinates. To do so:
</p>
<pre>layer thickness = (Z calibrated thickness) / (X calibrated thickness)
</pre>
<p>In our example of 4x4x50 nm/px:
</p>
<pre>layer thickness = 50 / 4 = 12.5
</pre>
<p>Then we must set this thickness to every section. This consists of the following steps to be done on the <i>Layer Tree</i> This is the tree that lists the layers in the TrakEM2 window):
</p>
<pre>1. Right-click on the "Top Level [Layer Set]" node of the <i>Layer Tree</i>.
   Then choose "Reset layer Z and thickness".
2. Click on the first layer node, then <kbd class="keyboard-key nowrap" style="border: 1px solid #aaa; -moz-border-radius: 0.2em; -webkit-border-radius: 0.2em; border-radius: 0.2em; -moz-box-shadow: 0.1em 0.2em 0.2em #ddd; -webkit-box-shadow: 0.1em 0.2em 0.2em #ddd; box-shadow: 0.1em 0.2em 0.2em #ddd; background-color: #f9f9f9; background-image: -moz-linear-gradient(top, #eee, #f9f9f9, #eee); background-image: -o-linear-gradient(top, #eee, #f9f9f9, #eee); background-image: -webkit-linear-gradient(top, #eee, #f9f9f9, #eee); background-image: linear-gradient(&#91;&#91;:Template:Linear-gradient/legacy]], #eee, #f9f9f9, #eee); padding: 0.1em 0.3em; font-family: inherit; font-size: 0.85em;"><span class="Unicode"></span> Shift</kbd>+<kbd class="keyboard-key nowrap" style="border: 1px solid #aaa; -moz-border-radius: 0.2em; -webkit-border-radius: 0.2em; border-radius: 0.2em; -moz-box-shadow: 0.1em 0.2em 0.2em #ddd; -webkit-box-shadow: 0.1em 0.2em 0.2em #ddd; box-shadow: 0.1em 0.2em 0.2em #ddd; background-color: #f9f9f9; background-image: -moz-linear-gradient(top, #eee, #f9f9f9, #eee); background-image: -o-linear-gradient(top, #eee, #f9f9f9, #eee); background-image: -webkit-linear-gradient(top, #eee, #f9f9f9, #eee); background-image: linear-gradient(&#91;&#91;:Template:Linear-gradient/legacy]], #eee, #f9f9f9, #eee); padding: 0.1em 0.3em; font-family: inherit; font-size: 0.85em;">click</kbd> on the last layer node.
   All nodes will be selected.
3. Right-click on the selected nodes and choose "Scale...".
4. In the dialog, type in "12.5"--the value we computed above.
</pre>
<p>To accomplish the same programatically, do the following:
</p>
<pre class="brush:python">
z = 0
thickness = 12.5
# Obtain the LayerSet instance:
layerset = Display.getFront().getLayerSet()
#
for layer in layerset.getLayers():
  layer.setZ(z)
  layer.setThickness(thickness)
  z += thickness

# Update the GUI
layerset.getProject().getLayerTree().updateUILater()
</pre>
<h1><span class="mw-headline" id="Interacting_with_Treeline.2C_AreaTree_and_Connector">Interacting with Treeline, AreaTree and Connector</span></h1>
<p>All three types: "treeline", "areatree", and "connector" are expressed by homonimous classes that inherit from the abstract class <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">ini.trakem2.display.Tree</a>.
</p><p>A <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a> is a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Displayable.html">Displayable</a> and hence presents properties such as title, alpha, color, locked, visible ... which are accessible with their homonimous set and get methods (e.g. <i>setAlpha(0.8f);</i>, <i>getAlpha();</i> etc.)
</p><p>The <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a> consists of a root <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a> and public methods to access it and modify it.
</p><p>The root <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a> gives access to the rest of the nodes of the <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a>. From the canvas, a user would push 'r' on a selected Treeline, AreaTree or Connector to bring the field of view to where the root node is. From code, we would call:
</p>
<pre class="brush:python">
# Acquire a reference the selected object in the Display
t = Display.getFront().getActive()
# If t is not a Tree, the following will fail:
root = t.getRoot()
</pre>
<p>Now that we have a reference to the root <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a>, we'll ask it to give us the entire collection of subtree nodes: all nodes in the <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a>:
</p>
<pre class="brush:python">
nodes = root.getSubtreeNodes()
</pre>
<p>The <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini.trakem2/display/Node.NodeCollection.html">NodeCollection</a> is lazy and doesn't do caching. If you are planning on calling size() on it, and then iterating its nodes, you would end up iterating the whole sequence twice. So let's start by duplicating it:
</p>
<pre class="brush:python">
nodes = [nd for nd in nodes]
</pre>
<p>Each <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a> has:
</p>
<ol>
  <li>X, Y coordinates, relative to the local coordinate system of the Tree that contains the <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a>.</li>
 <li>A reference to a layer (get it with nd.getLayer()). The <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Layer.html">Layer</a> has a getZ() method to get the Z coordinate (in pixels).</li>
 <li>A data field, which can be a radius or a java.awt.geom.Area (see below).</li>
</ol>
<p>Each <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a> contains a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html#getData()">getData()</a> public method to acquire whatever it is that it has:
</p>
<ul>
 <li>Treeline and Connector: its nodes <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html#getData()">getData()</a> return a radius. The default value is zero.</li>
 <li>AreaTree: its nodes <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html#getData()">getData()</a> return a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/java/awt/geom/Area.html">java.awt.geom.Area</a> instance, or null if none yet assigned to it.</li>
</ul>
<h2><span class="mw-headline" id="Obtaining_the_X.2CY.2CZ_coordinates_of_all_nodes_in_a_Tree">Obtaining the X,Y,Z coordinates of all nodes in a Tree</span></h2>
<p>Here is how to iterate over all the node's X,Y,Z positions, in world coordinates:
</p>
<pre class="brush:python">
from ini.trakem2.display import Display
from jarray import array

def getNodeCoordinates(tree):
  """ Returns a map of Node instances vs. their X,Y,Z world coordinates. """
  root = tree.getRoot()
  if root is None:
    return {}
  calibration = tree.getLayerSet().getCalibration()
  affine = tree.getAffineTransform()
  coords = {}
  #
  for nd in root.getSubtreeNodes():
    fp = array([nd.getX(), nd.getY()], 'f')
    affine.transform(fp, 0, fp, 0, 1)
    x = fp[0] * calibration.pixelWidth
    y = fp[1] * calibration.pixelHeight
    z = nd.getLayer().getZ() * calibration.pixelWidth   # a TrakEM2 oddity
    # data may be a radius or a java.awt.geom.Area 
    coords[nd] = [x, y, z]
  #
  return coords

# Obtain the tree selected in the canvas:
tree = Display.getFront().getActive()

# Print all its node coordinates:
for node, coord in getNodeCoordinates(tree).iteritems():
  x, y, z = coord
  print "Coords for node", node, "&#160;: ", x, y, z
</pre>
<h2><span class="mw-headline" id="Sorting_nodes_by_their_tags">Sorting nodes by their tags</span></h2>
<pre class="brush:python">
from ini.trakem2.display import Display
 
def sortNodesByTags(tree):
  table = {}
  root = tree.getRoot()
  if root is None:
    return table # empty
  #
  for nd in tree.getRoot().getSubtreeNodes():
    tags = nd.getTags()
    if tags is None:
      continue
    for tag in tags:
      tagged = None
      if table.has_key(tag):
        tagged = table[tag]
      else:
        tagged = []  
        table[tag] = tagged
      tagged.append(nd)
  #
  return table
 
# Obtain the currently selected Tree in the canvas:
tree = Display.getFront().getActive()
 
# Print the number of nodes that have any given tag:
for tag, tagged in sortNodesByTags(tree).iteritems():
  print "Nodes for tag '" + str(tag) + "':", len(tagged)
</pre>
<h2><span class="mw-headline" id="Compute_the_betweenness_centrality_of_every_node">Compute the betweenness centrality of every node</span></h2>
<p>The centrality is the measure of how important is a node in tree, according to how many times any possible pair of nodes is linked by a path that passes through that node.
</p><p>The method we use is <a rel="nofollow" class="external text" href="http://www.informatik.uni-konstanz.de/~brandes/">Ulrik Brande</a>'s fast algorithm for computing betweenness centrality (see the <a rel="nofollow" class="external text" href="http://www.google.com/url?sa=t&amp;source=web&amp;cd=1&amp;ved=0CBcQFjAA&amp;url=http%3A%2F%2Fciteseerx.ist.psu.edu%2Fviewdoc%2Fdownload%3Fdoi%3D10.1.1.11.2024%26rep%3Drep1%26type%3Dpdf&amp;ei=krO5TPKvNMXN4AbS4OHdDQ&amp;usg=AFQjCNELHtt9Gb5KHMzRCeTsqI1uDoqxew">paper</a>).
</p><p>The method <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html#computeCentrality()">computeCentrality()</a> of class <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a> returns as a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/java/util/Map.html">Map</a> of <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Node.html">Node</a> instance vs. its centrality value:
</p>
<pre class="brush:python">
from ini.trakem2.display import Display

# Obtain the currently selected Tree in the canvas:
tree = Display.getFront().getActive()

# Compute betweenness centrality
bc = tree.computeCentrality()   # a java.util.Map

# Print the value for each node
for e in bc.entrySet():
  print e.getKey(), "=&gt;", e.getValue()
</pre>
<p><br />
We may then use the centrality to colorize the tree with a heat map: the higher the centrality value, the more intense the yellow color; the lower, the more intense the blue color:
</p>
<pre class="brush:python">
from ini.trakem2.display import Display
from java.awt import Color

def computeColor(centrality, highest):
  red = centrality / float(highest)
  blue = 1 - red
  return Color(red, red, blue)

# Obtain the currently selected Tree in the canvas:
tree = Display.getFront().getActive()

# Compute betweenness centrality
bc = tree.computeCentrality()   # a java.util.Map

# Find out the maximum centrality value, to scale:
maximum = reduce(max, bc.values())

# Colorize each node according to its centrality
for e in bc.entrySet():
  node = e.getKey()
  centrality = e.getValue()
  node.setColor(computeColor(centrality, maximum))

# Update display
Display.repaint()

# Show the tree in the 3D Viewer
Display3D.show(tree.getProject().findProjectThing(tree))
</pre>
<h2><span class="mw-headline" id="Compute_the_degree_of_every_node">Compute the degree of every node</span></h2>
<p>The degree of a node is the number of parent nodes that separate it from the root node. It's a built-in function in <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a> (and also in <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Node</a>):
</p><p>In the following example, we colorize the tree based on the degree of the node: the closer to the root, the hotest:
</p>
<pre class="brush:python">
from ini.trakem2.display import Display
from java.awt import Color

def computeColor(degree, highest):
  blue = degree / float(highest)
  red = 1 - blue
  return Color(red, red, blue)

# Obtain the currently selected Tree in the canvas:
tree = Display.getFront().getActive()

# Compute betweenness centrality
degrees = tree.computeAllDegrees()   # a java.util.Map

# Find out the maximum degree value, to scale:
maximum = reduce(max, degrees.values())

# Colorize each node according to its degree:
for e in degrees.entrySet():
  node = e.getKey()
  degree = e.getValue()
  node.setColor(computeColor(degree, maximum))

# Update display
Display.repaint()

# Show the tree in the 3D Viewer
Display3D.show(tree.getProject().findProjectThing(tree))
</pre>
<h2><span class="mw-headline" id="Find_branch_nodes_or_end_nodes">Find branch nodes or end nodes</span></h2>
<p>The <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a> class offers methods to obtain the list of all branch points, end points, or both:
</p>
<pre class="brush:python">
from ini.trakem2.display import Display

# Obtain the currently selected treeline or areatree or connector:
tree = Display.getFront().getActive()

# A collection of all end nodes (not lazy):
endNodes = tree.getEndNodes()

# A lazy collection of all branch nodes:
branchNodes = tree.getBranchNodes()

# A lazy collection of both all end nodes and all branch nodes:
endOrBranchNodes = tree.getBranchAndEndNodes()
</pre>
<p>Remember that these lazy collections are non-caching. If you call size() on it, it will traverse the whole tree of nodes just to find out how many nodes of that kind exist.
</p><p>If you want to sort out all nodes in one pass, query the number of children that each node has:
</p>
<pre>* if 0, it's an end node
* if 1, it's a slab node
* if more than 1, it's a branch node
</pre>
<pre class="brush:python">
from ini.trakem2.display import Display

# Obtain the currently selected treeline or areatree or connector:
tree = Display.getFront().getActive()

endNodes = []
branchNodes = []
rest = []

for nd in tree.getRoot().getSubtreeNodes():
  count = nd.getChildrenCount()
  if 1 == count:
    rest.append(nd)
  elif 0 == count:
    endNodes.append(nd)
  else:
    branchNodes.append(nd)

print "Found:"
print "end nodes:", len(endNodes)
print "branch nodes:", len(branchNodes)
print "slab nodes:", len(rest)
</pre>
<p>Keep in mind that the <i>root</i> node will be listed among the nodes above, so it's not counted as an end node (unless it doesn't have any children, e.g. when the tree consists of only the root node).
</p>
<h2><span class="mw-headline" id="Find_out_at_which_nodes_the_tree_is_connected_to_other_trees.2C_via_Connector">Find out at which nodes the tree is connected to other trees, via Connector</span></h2>
<p>The idea here is to iterate all nodes of a tree, and determine, for each node, whether it is enclosed by the origin point of a Connector instance. Then, we query that connector for its target objects. In the end, we obtain a table of nodes vs. lists of objects that node is connected to:
</p>
<pre class="brush:python">
from ini.trakem2.display import Display, Connector
from jarray import array
from java.awt.geom import Area
from java.awt import Rectangle
 
# Obtain the currently selected treeline or areatree:
tree = Display.getFront().getActive()
affine = tree.getAffineTransform()
layerset = tree.getLayerSet()
 
# Maps of nd vs list of trees:
outgoing = {}   # e.g. presynaptic to some trees
 
for nd in tree.getRoot().getSubtreeNodes():
  # Obtain the node position in world coordinates 
  fp = array([nd.getX(), nd.getY()], 'f')
  affine.transform(fp, 0, fp, 0, 1)
  x = int(fp[0])
  y = int(fp[1])
  # Query the LayerSet for Connector objects that intersect it
  cs = layerset.findZDisplayables(Connector, nd.getLayer(), x, y, False)
  if cs.isEmpty():
    continue
  # Else, get the target Tree instances that each connector links to:
  targets = []
  area = Area(Rectangle(x, y, 1, 1))
  for connector in cs:
    if connector.intersectsOrigin(area):
      for target in connector.getTargets(Tree):
        targets.append(target)      
  if len(targets) &gt; 0:
    outgoing[nd] = targets
 
# print the map of nodes and the number of trees each connects to:
for node, targets in outgoing.iteritems():
  print node, " connects to", len(targets)
</pre>
<p><br />
Similarly, we could compute the incomming connections. There is a convenience method <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html#findConnectors()">findConnectors()</a> in class <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.html">Tree</a> to return two lists: that of the outgoing and that of the incomming Connector instances. From these, one can easily get the connectivity graph, which you may also get by right-clicking on a Display and going for "Export - Connectivity graph...".
</p>
<h2><span class="mw-headline" id="How_to_find_out_the_network_of_all_arbors.2C_related_via_Connector_instances">How to find out the network of all arbors, related via Connector instances</span></h2>
<p>The easiest way is to iterate all connectors and find out which objects they are relating. A <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Connector.html">Connector</a> object has an origin (the root node) and any number of targets (all children nodes of the root node). Each node has a radius; any other object in the TrakEM2 project that intersects with the world coordinates of that radius will be considered associated as an origin or a target.
</p>
<pre class="brush:python">
from ini.trakem2.display import Display, Connector, Tree

layerset = Display.getFront().getLayerSet()

# table of relationships: one source vs. its list of targets
graph = {}

for connector in layerset.getZDisplayables(Connector):
  targets = []
  for targetSet in connector.getTargets(Tree):
    for target in targetSet:
      targets.append(target)
  for origin in connector.getOrigins(Tree):
    ls = None
    if graph.has_key(origin):
      graph[origin] += targets
    else:
      graph[origin] = targets

# print the graph (we print the id of each object):
for origin,targets in graph.iteritems():
  tids = ""
  for target in targets:
    tids += str(target.id) + ", "
  print origin.id, "=&gt;", tids
</pre>
<p>Notice how about we called <i>getOrigins(Tree)</i> and <i>getTargets(Tree)</i>, which filters all potential origins and targets (Patch--an image--, AreaList, etc.) so that only Tree instances will be present in the lists.
</p><p><b>NOTE</b>: you may also want to use the "Export - NeuroML" menu command, in the right-click popup menu.
</p>
<h2><span class="mw-headline" id="Measure_all_spine_necks_in_a_neuronal_arbor">Measure all spine necks in a neuronal arbor</span></h2>
<p><b>UPDATE</b>: as of version 0.8n, this functionality is included in TrakEM2. Right-click on a selected treeline or areatree and choose "Measure - Shortest distances between all pairs of nodes tagged as..."
</p><p>The idea is to label the beginning of a spine neck with the tag "neck start" and the end of the spine neck with the tag "neck end". It is assumed that the "next end" will always be in the subtree of the "neck start" node; in other words, that the direction of the tree is from "neck start" to "neck end".
</p><p>Then, we iterate all nodes of the arbor looking for nodes that have the "neck start" tag and measure the calibrated length of the neck. All measurements for all spine necks are printed out.
</p>
<pre class="brush:python">
# 2011-03-13 Albert Cardona for Nuno da Costa
# 
# For a given Treeline or AreaTree that represents a neuronal arbor,
# find all nodes that contain the tag "neck start"
# and for each of those find the distance to a node
# in their subtree that contains the tag "neck end".
#
# In short, measure the lengths of all spine necks
# labeled as such in the arbor.


from math import sqrt
from ini.trakem2.display import Display, AreaTree, Treeline

def findNeck(startNode):
  """ Assumes necks are not branched. """ 
  neck = []
  for node in startNode.getSubtreeNodes():
    tags = getTagsAsStrings(node)
    if tags is None or not "neck end" in tags:
      neck.append(node) # growing the neck
      continue
    # Else, end of neck:
    neck.append(node)
    return neck
  print "Did not find a node with an end tag, for parent node " + startNode
  return None # end tag not found!


def getTagsAsStrings(node):
  found = set()
  tags = node.getTags()
  if tags is None or 0 == len(tags):
    return found
  for tag in tags:
    found.add(tag.toString())
  return found


def measureSpineNecks(neuron):
  """ Expects an AreaTree or a Treeline for neuron.
  Assumes that nodes with a tag "neck start" are parents or superparents of nodes with tags of "neck end".
  """
  print "Measurements for neuron '" + str(neuron) + "':"
  for node in neuron.getRoot().getSubtreeNodes():
    # Check if the node has the start tag
    tags = getTagsAsStrings(node)
    if tags is None or not "neck start" in tags:
      continue
    # Find its child node that has an end tag
    neck = findNeck(node)
    if neck is None:
      continue
    distance = neuron.measurePathDistance(neck[0], neck[-1])
    print "  id:", neuron.getId(), "-- neck length: ", distance


def isTree(x):
  return isinstance(x, Treeline) or isinstance(x, AreaTree)



# Measure in all treelines or areatrees:
#trees = filter(isTree, Display.getFront().getLayerSet().getZDisplayables())

# Measure only in the selected treelines or areatrees:
trees = filter(isTree, Display.getSelected())

if 0 == len(trees):
  print "No trees found!"
else:
  for neuron in trees:
    measureSpineNecks(neuron)
</pre>
<h1><span class="mw-headline" id="Interact_with_a_Ball_object">Interact with a Ball object</span></h1>
<h2><span class="mw-headline" id="Set_the_radius_of_all_balls_of_all_Ball_objects_in_a_project">Set the radius of all balls of all Ball objects in a project</span></h2>
<pre class="brush:python">
##############
# Set a specific radius to all individual spheres
# of all Ball objects of a TrakEM2 project.


calibrated_radius = 40  # in microns, nm, whatever


display = Display.getFront()
layerset = display.getLayerSet()
cal = layerset.getCalibration()
# bring radius to pixels
new_radius = calibrated_radius / cal.pixelWidth

for ballOb in layerset.getZDisplayables(Ball):
  for i in range(ballOb.getCount()):
    ballOb.setRadius(i, new_radius)
  ballOb.repaint(True, None)
##############
</pre>
<h2><span class="mw-headline" id="Export_all_Ball_objects_as_a_CSV_file">Export all Ball objects as a CSV file</span></h2>
<pre class="brush:python">
# Open a text window containing all Ball objects as a CSV file,
# in calibrated coordinates.
# The text window has a "File - Save" menu for saving to a file.

# Albert Cardona 2015-07-02 for Jemima Burden at UCL.

# See also the API of the Ball class:
# https://github.com/trakem2/TrakEM2/blob/master/TrakEM2_/src/main/java/ini/trakem2/display/Ball.java#L716


from ini.trakem2.display import Display, Ball
from ij.text import TextWindow

ball_obs = Display.getFront().getLayerSet().getZDisplayables(Ball)

# One entry for each id,x,y,z,r 
rows = []

# Iterate every Ball instance, which contains one or more x,y,z,r balls
for ball_ob in ball_obs:
  id = ball_ob.getId()
  # Iterate every x,y,z,r ball of a Ball instance, calibrated
  wbs = ball_ob.getWorldBalls()
  for ball_coords in wbs:
    # Store every ball as a row with id, x, y, z, r
    rows.append(str(id) + "," + ",".join(str(c) for c in ball_coords))

csv = "\n".join(rows)

t = TextWindow("Balls CSV", csv, 400, 400)
</pre>
<h1><span class="mw-headline" id="Generate_3D_meshes">Generate 3D meshes</span></h1>
<p>In TrakEM2, 3D meshes are generated as a list of <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Java3D/index.html?org/scijava/vecmath/Point3f.html">Point3f</a> for each object. Then the list is wrapped into any of the subclasses of <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/customnode/CustomMesh.html">CustomMesh</a> of the 3D Viewer library, such as a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/customnode/CustomTriangleMesh.html">CustomTriangleMesh</a> or a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/customnode/CustomLineMesh.html">CustomLineMesh</a>. Then these mesh objects are encapsulated into a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ij3d/Content.html">Content</a> object and added to an instance of the <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ij3d/Image3DUniverse.html">Image3DUniverse</a>, which is the main window of the 3D Viewer.
</p><p>Of course, via scripting many of these steps may be skipped. Below are several examples on how to generate meshes programmatically and save them in <a rel="nofollow" class="external text" href="http://www.martinreddy.net/gfx/3d/OBJ.spec">Wavefront</a> format.
</p>
<h3><span class="mw-headline" id="Generate_a_3D_mesh_for_an_AreaList">Generate a 3D mesh for an AreaList</span></h3>
<p>This script illustrates how to bypass the 3D Viewer to generate meshes from an AreaList and then export the data in Wavefront format. The script exports an AreaList that has been selected in the front Display.
</p><p>To export all selected objects, loop through the <i>Display.getSelected()</i>.
</p><p>To export all arealists, loop through <i>Display.getFront().getLayerSet().getZDisplayables(AreaList)</i>.
</p>
<pre class="brush:python">
from ini.trakem2.display import Display
from org.scijava.vecmath import Color3f
from customnode import WavefrontExporter, CustomTriangleMesh
from java.io import StringWriter
from ij.text import TextWindow

# Get the selected AreaList
arealist = Display.getSelected()[0]

# Create the triangle mesh with resample of 1 (no resampling)
# CAUTION: may take a long time. Try first with a resampling of at least 10.
resample = 1
triangles = arealist.generateTriangles(1, resample)

# Prepare a 3D Viewer object to provide interpretation
color = Color3f(1.0, 1.0, 0.0)
transparency = 0.0
mesh = CustomTriangleMesh(triangles, color, transparency)

# Write the mesh as Wavefront
name = "arealist-" + str(arealist.id)
m = {name&#160;: mesh}
meshData = StringWriter()
materialData = StringWriter()
materialFileName = name + ".mtl"
WavefrontExporter.save(m, materialFileName, meshData, materialData)

# Show the text of the files in a window
# then you save it with "File - Save"
TextWindow(".obj", meshData.toString(), 400, 400)
TextWindow(materialFileName, materialData.toString(), 400, 400)
</pre>
<p><br />
</p>
<h3><span class="mw-headline" id="Generate_a_3D_mesh_for_an_AreaTree">Generate a 3D mesh for an AreaTree</span></h3>
<p>Just like for an AreaList (see above), but extract the triangles with:
</p>
<pre class="brush:python">
triangles = areatree.generateMesh(1, resample).verts
</pre>
<p>The <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/AreaTree.html">AreaTree</a>'s generateMesh returns a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Tree.MeshData.html">MeshData</a> object with the list of vertices and the list of colors of each vertex. The <i>generateTriangles</i> method of an <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/AreaTree.html">AreaTree</a> returns a list of <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Java3D/index.html?org/scijava/vecmath/Point3f.html">Point3f</a> that are ready for creating a <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/customnode/CustomLineMesh.html">CustomLineMesh</a> (in PAIRWISE mode) to represent the skeleton.
</p>
<h1><span class="mw-headline" id="Save_the_project_while_running_a_task">Save the project while running a task</span></h1>
<p>While a task is running, the right-click menu shows only an entry to cancel the task. To save the project while the task is running, type the following into the <a href="http://imagej.net/Jython_Interpreter" class="mw-redirect" title="Jython Interpreter">Jython Interpreter</a>, and push return to execute it:
</p>
<pre class="brush:python">
Display.getFront().getProject().save()
</pre>
<p>If you would like to edit the Project properties, the following code will open the "Project - Properties..." dialog:
</p>
<pre class="brush:python">
Display.getFront().getProject().adjustProperties()
</pre>
<p>In the above dialog, you will be able to set the autosaving interval (see the bottom text field of the dialog that opens). The interval defaults to zero (meaning never). Set it for example to 30 (once every half hour).
</p><p>Of course it may be easier to set that autosaving interval <b>before</b> running the long task!
</p>
<h1><span class="mw-headline" id="Create_a_TrakEM2_project_for_fast_visualization.2C_without_mipmaps">Create a TrakEM2 project for fast visualization, without mipmaps</span></h1>
<p>Create a TrakEM2 project that avoids generating mipmaps, then import lots of images from a text file that has four columns: the file path, the X, the Y, and the section index of each image tile. Then acquire a snapshot of the first section.
</p><p>As a result of the script, a new Project tab will open in the "TrakEM2" window, and a new Display window will show. At any time, run "project.saveAs(xmlfilepath)" to store the project in an XML file, and from then on just "project.save()". Or right-click and choose "Project - Save", or push 's'.
</p>
<pre class="brush:python">
# Albert Cardona 2011-02-02
# At Madison, Wisconsin, with Erwin Frise
from ini.trakem2 import Project
from ij.gui import Toolbar
from java.awt import Color
from ij import ImagePlus

project = Project.newFSProject("blank", None, "/home/albert/Desktop/t2/")
loader = project.getLoader()
loader.setMipMapsRegeneration(False) # disable mipmaps
layerset = project.getRootLayerSet()
layerset.setSnapshotsMode(1) # outlines

task = loader.importImages(
          layerset.getLayers().get(0),  # the first layer
          "/home/albert/Desktop/t2/example-data/images/list.txt", # the absolute file path to the text file with absolute image file paths
          " ", # the column separator  &lt;path&gt; &lt;x&gt; &lt;y&gt; &lt;section index&gt;
          1.0, # section thickness, defaults to 1
          1.0, # calibration, defaults to 1
          False, # whether to homogenize contrast, avoid
          1.0) # scaling factor, default to 1

task.join() # Optional: wait until all images have been imported

# Export a snapshot of the layer at 25% magnification

scale = 0.25
layer = layerset.getLayers().get(0)
flat = loader.makeFlatImage(ImagePlus.COLOR_RGB, layer, layerset.get2DBounds(), scale, layer.getAll(Patch), Color.black)

imp = ImagePlus("snap " + str(scale), flat).show()

print "done!"
</pre>
<p><br />
</p>
<h1><span class="mw-headline" id="Create_a_snapshot_in_8-bit.2C_16-bit.2C_32-bit_or_RGB">Create a snapshot in 8-bit, 16-bit, 32-bit or RGB</span></h1>
<p>From the right-click menu, one may choose "Export - Make flat image", which opens a dialog that lets one choose between 8-bit and RGB. These snapshots are created from the mipmaps, which are all 8-bit or RGB images.
</p><p>On occasions, one wants to create a flattened montage of images in their original bit depth, such as 16-bit or 32-bit. For this purpose, the static function <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Patch.html#makeFlatImage(int,%20ini.trakem2.display.Layer,%20java.awt.Rectangle,%20double,%20java.util.Collection,%20java.awt.Color,%20boolean)">Patch.makeFlatImage</a> exists.
</p><p>Here is an example that, for a given Layer and set of selected Patch instances (image tiles) in it, it makes a 16-bit flat montage image and returns it as an ImageJ's ImageProcessor, at 50% the original scale.
</p>
<pre class="brush:python">
from ini.trakem2.display import Display, Patch
from java.awt import Color

front = Display.getFront() # the active TrakEM2 display window
layer = front.getLayer()
tiles = front.getSelection().get(Patch)  # selected Patch instances only
backgroundColor = Color.black
scale = 0.5

roi = tiles[0].getBoundingBox()
for tile in tiles[1:]:
  roi.add(tile.getBoundingBox())

print "Creating flat image from", len(tiles), "image tiles"

ip = Patch.makeFlatImage(
           ImagePlus.GRAY16,
           layer,
           roi,
           scale,
           tiles,
           backgroundColor,
           True)  # use the min and max of each tile

imp = ImagePlus("Flat montage", ip)
imp.show()
</pre>
<p><br />
For other output types, use ImagePlus.GRAY8, .GRAY16, GRAY32 or .COLOR_RGB, as listed in the documentation for the <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ij/ImagePlus.html">ImagePlus</a> class.
</p>
<h1><span class="mw-headline" id="Enrich_the_GUI_of_TrakEM">Enrich the GUI of TrakEM</span></h1>
<h3><span class="mw-headline" id="Add_an_extra_tab_to_a_Display">Add an extra tab to a Display</span></h3>
<p>TrakEM API is accessible at all times. Here is an example that adds a new tab to the display. The new tab consists of a JPanel with a single button in it.
</p><p>Notice that Jython lets you define the methods of event listeners as additional arguments to the constructor. So the JButton gets an actionPerformed method (from the ActionListener interface) just by referencing a declared method.
</p>
<pre class="brush:python">
# Albert Cardona 2010-03-19 at EMBL
# Specially demo'ed for Larry Lindsey

def doSomething(evt):
  IJ.showMessage("Button pushed!")

def addReconstructToolkit(display):
  tabs = display.getTabbedPane()
  # Check that it's not there already
  title = "Reconstruct toolbar"
  for i in range(tabs.getTabCount()):
    if tabs.getTitleAt(i) == title:
      IJ.showMessage("Reconstruct toolbar already in this Display!")
      return
  # Otherwise, add it new:
  from javax.swing import JPanel, JButton
  pane = JPanel()
  b = JButton("Push it", actionPerformed=doSomething)
  pane.add(b)
  tabs.add(title, pane)


front = Display.getFront()
if front is not None:
  addReconstructToolkit(front)
else:
  IJ.showMessage("Open a display first!")
</pre>
<h1><span class="mw-headline" id="See_also">See also</span></h1>
<h2><span class="mw-headline" id="TrakEM2_tutorials">TrakEM2 tutorials</span></h2>
<ul><li>TrakEM2 <a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/howto.html">how to</a>, with java code examples.</li>
<li>TrakEM2 <a href="http://imagej.net/TrakEM2_tutorials" title="TrakEM2 tutorials">video tutorials</a>.</li></ul>
<h2><span class="mw-headline" id="Jython_scripting">Jython scripting</span></h2>
<ul><li><a href="http://imagej.net/Jython_Scripting" title="Jython Scripting">Jython Scripting</a> in fiji.</li>
<li><a rel="nofollow" class="external text" href="http://www.jython.org">Jython webpage</a>.</li>
<li><a rel="nofollow" class="external text" href="http://www.ini.uzh.ch/~acardona/fiji-tutorial">Fiji scripting tutorial</a> in Jython.</li></ul>
<h2><span class="mw-headline" id="Jython_scripts_for_TrakEM2">Jython scripts for TrakEM2</span></h2>
<p>All the following are included in Fiji's plugins/Examples/TrakEM2_Example_Scripts/ folder:
</p>
<ul><li><a rel="nofollow" class="external text" href="https://github.com/fiji/fiji/blob/master/plugins/Examples/TrakEM2_Example_Scripts/extract_stack_under_arealist.py">Extract stack under AreaList</a> in TrakEM2.</li>
<li><a rel="nofollow" class="external text" href="https://github.com/fiji/fiji/blob/master/plugins/Examples/TrakEM2_Example_Scripts/T2_set_all_transforms_to_identity.py">Set all transforms to identity</a> for TrakEM2 objects.</li>
<li><a rel="nofollow" class="external text" href="https://github.com/fiji/fiji/blob/master/plugins/Examples/TrakEM2_Example_Scripts/T2_Select_All.py">Select All</a> objects in TrakEM2.</li>
<li><a rel="nofollow" class="external text" href="https://github.com/fiji/fiji/blob/master/plugins/Examples/TrakEM2_Example_Scripts/Measure_AreaLists.py">Measure AreaList</a> in TrakEM2.</li>
<li> A <a rel="nofollow" class="external text" href="https://github.com/acardona/Fiji-TrakEM2-scripts/tree/master/TrakEM2">collection of scripts for TrakEM2</a>, hosted by github. Mostly related to inspecting and analyzing <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Treeline.html">Treeline</a>, <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/AreaTree.html">AreaTree</a> and <a rel="nofollow" class="external text" href="https://fiji.sc/javadoc/ini/trakem2/display/Connector.html">Connector</a> instances, when used for neural circuit reconstruction.</li></ul>

<!-- 
NewPP limit report
Cached time: 20200713074029
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.084 seconds
Real time usage: 0.087 seconds
Preprocessor visited node count: 1343/1000000
Preprocessor generated node count: 7511/1000000
Postexpand include size: 5132/2097152 bytes
Template argument size: 992/2097152 bytes
Highest expansion depth: 6/40
Expensive parser function count: 0/3
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%   38.645      1 - -total
 86.16%   33.296      2 - Template:Key
 73.02%   28.219      2 - Template:Key_press/core
  7.83%    3.026      4 - Template:GitHub
  5.76%    2.225      2 - Template:Linear-gradient
  4.66%    1.800      2 - Template:Box-shadow
  2.91%    1.125      2 - Template:Border-radius
  2.31%    0.894      1 - Template:Unicode
  1.47%    0.569      2 - Template:Linear-gradient/legacy
-->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;oldid=41408">http://imagej.net/index.php?title=TrakEM2_Scripting&amp;oldid=41408</a>"</div>
							</div>

			<div id="footer">
				<p> This page was last modified on 24 January 2020, at 11:56.</p><ul><li><a href="http://imagej.net/ImageJ:Privacy_policy" title="ImageJ:Privacy policy">Privacy policy</a></li><li><a href="http://imagej.net/ImageJ:About" class="mw-redirect" title="ImageJ:About">About ImageJ</a></li><li><a href="http://imagej.net/Imprint" title="Imprint">Imprint</a></li><li><a href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li></ul>			</div>

			<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="http://imagej.net/Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="http://imagej.net/Category:Scripting" title="Category:Scripting">Scripting</a></li><li><a href="http://imagej.net/Category:TrakEM2" title="Category:TrakEM2">TrakEM2</a></li></ul></div></div>		</div>

		<div id="bottom-wrap">
		<div id="footer-wrap-inner">

		<div id="primary" class="footer">
			<ul>

			<li id="search" class="widget">
				<h3>Search</h3>
				<form action="http://imagej.net/index.php" id="searchform">
					<input type='hidden' name="title" value="Special:Search" />
					<div>
						<input name="search" placeholder="Search ImageJ" title="Search ImageJ [f]" accesskey="f" id="s"/>						<input type="submit" name="go" value="Search" title="Go to a page with this exact name if it exists" class="searchButton" id="searchsubmit"/>					</div>
				</form>
			</li>

			
						<li class="widget">
				<h3>Personal tools</h3>
				<div>
					<ul>
					<li id="pt-createaccount"><a href="http://imagej.net/index.php?title=Special:CreateAccount&amp;returnto=TrakEM2+Scripting" title="You are encouraged to create an account and log in; however, it is not mandatory">Create account</a></li><li id="pt-login"><a href="http://imagej.net/index.php?title=Special:UserLogin&amp;returnto=TrakEM2+Scripting" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>					</ul>
				</div>
			</li>
			
			<li class="widget">
							</li>

			</ul>
		</div>

		<div id="secondary" class="footer">
			<ul>

			<li id="toolbox" class="widget">
				<h3>Tools</h3>
				<ul>
				<li id="t-whatlinkshere"><a href="http://imagej.net/Special:WhatLinksHere/TrakEM2_Scripting" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="http://imagej.net/Special:RecentChangesLinked/TrakEM2_Scripting" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="http://imagej.net/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;oldid=41408" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="http://imagej.net/index.php?title=TrakEM2_Scripting&amp;action=info" title="More information about this page">Page information</a></li>				</ul>
			</li>

			
			<li class="widget">
							</li>

			</ul>
		</div>

		<div id="ternary" class="footer">
			<ul>

			<li class="widget">
				<img id="logo" src="../skins/imagej-128.png" alt=""/>			</li>

			<li class="widget">
				<h3><span class="mw-headline" id="MORE_TOOLS">MORE TOOLS</span></h3>
<ul><li> <a href="http://imagej.net/Special:ChangeUploadPassword" title="Special:ChangeUploadPassword">Set/change upload password</a></li>
<li> <a href="http://imagej.net/Special:RecentChanges" title="Special:RecentChanges">Recent changes</a></li>
<li> <a href="http://imagej.net/Special:LonelyPages" title="Special:LonelyPages">Orphaned pages</a></li></ul>
			</li>

			</ul>
		</div>
		<div style="clear: both"></div>

		</div>
		</div>

		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.loader.load(["ext.fancytree","ext.suckerfish","mediawiki.toc","mediawiki.action.view.postEdit","site","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","ext.SimpleTooltip"]);});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":311});});</script>
		</body>
		</html>
		